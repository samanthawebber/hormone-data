<section class="grid gap-6 lg:grid-cols-[1fr_1.2fr]">
  <article class="rounded-2xl border border-emerald-200 bg-white/95 p-6 shadow-sm">
    <p class="text-xs uppercase tracking-[0.2em] text-cyan-600"><%= @study.topic.presence || "General" %></p>
    <h2 class="mt-1 text-2xl font-semibold text-emerald-800"><%= @study.title %></h2>
    <p class="mt-3 text-sm leading-relaxed text-slate-700"><%= @study.description %></p>

    <hr class="my-5 border-slate-200" />

    <h3 class="text-sm font-semibold uppercase tracking-[0.14em] text-violet-700">Submit data</h3>
    <% if logged_in? %>
      <%= form_with model: [@study, @submission], class: "mt-3 space-y-3" do |form| %>
        <% @study.study_parameters.each do |parameter| %>
          <div>
            <label class="mb-1 block text-sm font-medium text-slate-700" for="submission_values_<%= parameter.id %>">
              <%= parameter.name %>
              <% if parameter.unit.present? %>
                <span class="text-xs text-slate-500">(<%= parameter.unit %>)</span>
              <% end %>
            </label>
            <%= number_field_tag "submission[values][#{parameter.id}]", nil,
                                 id: "submission_values_#{parameter.id}",
                                 step: :any,
                                 min: parameter.min_value,
                                 max: parameter.max_value,
                                 required: true,
                                 class: "w-full rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500" %>
          </div>
        <% end %>

        <%= form.submit "Submit anonymously", class: "w-full rounded-xl bg-cyan-600 px-4 py-2 text-sm font-semibold text-white hover:bg-cyan-700" %>
      <% end %>
    <% else %>
      <div class="mt-3 rounded-xl border border-cyan-200 bg-cyan-50 p-4 text-sm text-cyan-900">
        Please <%= link_to "log in", login_path, class: "font-semibold underline" %> or
        <%= link_to "create an account", signup_path, class: "font-semibold underline" %>
        to submit study data.
      </div>
    <% end %>
  </article>

  <article class="space-y-4">
    <% @chart_data.each do |series| %>
      <section class="rounded-2xl border border-slate-200 bg-white/95 p-4 shadow-sm">
        <div class="mb-2 flex items-center justify-between">
          <h3 class="font-semibold text-slate-800"><%= series[:name] %></h3>
          <p class="text-xs text-slate-500">
            Average:
            <span class="font-semibold text-blue-700"><%= series[:average].presence || "N/A" %><%= series[:unit].present? ? " #{series[:unit]}" : "" %></span>
          </p>
        </div>
        <canvas id="series-chart-<%= series[:parameter_id] %>" height="120"></canvas>
      </section>
    <% end %>
  </article>
</section>

<section class="mt-6 rounded-2xl border border-slate-200 bg-white/95 p-6 shadow-sm">
  <h3 class="text-lg font-semibold text-violet-800">Recent submissions</h3>

  <div class="mt-4 overflow-x-auto">
    <table class="min-w-full border-collapse text-sm">
      <thead>
        <tr class="border-b border-slate-200 text-left text-xs uppercase tracking-[0.12em] text-slate-500">
          <th class="px-3 py-2">When</th>
          <th class="px-3 py-2">Participant</th>
          <% @study.study_parameters.each do |parameter| %>
            <th class="px-3 py-2"><%= parameter.name %></th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @recent_submissions.each do |submission| %>
          <tr class="border-b border-slate-100 text-slate-700">
            <td class="px-3 py-2"><%= submission.created_at.strftime("%Y-%m-%d %H:%M") %></td>
            <td class="px-3 py-2 text-xs text-cyan-700"><%= submission.user.anonymous_handle %></td>
            <% @study.study_parameters.each do |parameter| %>
              <td class="px-3 py-2">
                <%= submission.values[parameter.name] %>
                <%= parameter.unit %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</section>

<script id="study-chart-data" type="application/json"><%= raw @chart_data.to_json %></script>
<script>
  const renderStudyCharts = () => {
    const element = document.getElementById("study-chart-data");
    if (!element || element.dataset.ready === "true") return;

    const chartData = JSON.parse(element.textContent);

    chartData.forEach((series) => {
      const canvas = document.getElementById(`series-chart-${series.parameter_id}`);
      if (!canvas || canvas.dataset.ready === "true") return;

      canvas.dataset.ready = "true";

      new Chart(canvas, {
        type: "line",
        data: {
          labels: series.points.map((point) => point.x),
          datasets: [{
            label: `${series.name}${series.unit ? ` (${series.unit})` : ""}`,
            data: series.points.map((point) => point.y),
            borderColor: "#2563eb",
            backgroundColor: "rgba(37, 99, 235, 0.18)",
            tension: 0.28,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: false },
            x: { ticks: { maxRotation: 45, minRotation: 45 } }
          },
          plugins: {
            legend: {
              labels: {
                color: "#334155"
              }
            }
          }
        }
      });
    });

    element.dataset.ready = "true";
  };

  document.addEventListener("DOMContentLoaded", renderStudyCharts);
  document.addEventListener("turbo:load", renderStudyCharts);
</script>
